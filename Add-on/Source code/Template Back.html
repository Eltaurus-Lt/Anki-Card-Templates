<div id="backwrap" class="frontside">
	{{FrontSide}}
	<button id="mem-flip" style="opacity: 0;">flip</button>

	<div class="card-content back">  
		<div class="mem-alert"></div>   
		<div class="mem-field">
			<label>Learnable</label>
			<h2>{{Learnable}}</h2>
			<span id="spellcheck" class=""></span>
		</div>   
		<div class="mem-field">
			<label>Definition</label>
			<h3>{{Definition}}</h3>
		</div>

		<div class="sep"></div>


		{{#Extra}}
			<div class="mem-field">
				<label>Extra</label>
				<h4>{{Extra}}</h4>      
			</div>
		{{/Extra}}
		{{#Extra 2}}
			<div class="mem-field">
				<label>Extra 2</label>
				<h4>{{Extra 2}}</h4>
			</div>
		{{/Extra 2}}
		{{#Audio}}
			<div class="mem-field">
				<label>Audio</label>
				<h4>{{Audio}}</h4>
			</div>
		{{/Audio}}
  </div>	
</div>




<!-- --------------------- user prior scripts --------------------- -->
<script>
  //place your scripts here

</script>


<!-- ---------------------  template scripts  --------------------- -->

<script>
//generate random page id
pid = Array.from({length:16}, () => String.fromCharCode(Math.floor(Math.random() * 94) + 33)).join('');
//console.log("pageid: ", pid);

//get user answer
userAns = sessionStorage.getItem("userAnswer");
if (userAns === null) {
	document.getElementsByClassName("mem-alert")[0].innerText = "#error loading answer!";
	userAns = '';
} else if (userAns.trim()) {
	document.getElementsByClassName("mem-alert")[0].innerHTML = userAns; //text formatting, images and audio
} 
if (typeAns.tagName === 'INPUT') {
	typeAns.value = userAns;
	typeAns.disabled = true;
} else {
	typeAns.innerHTML = '<span>' + userAns + '</span>'; //backward compativility with stock Anki typing
}

console.log(`user answer: ${userAns} | correct answer: ${corrAns}`);
</script>

<script>
//answer comparison rules
function rmEnc(s) {
	//removes parts enclosed in the innermost parentheses
	return s.replace(/\x28[^()]*\x29/g, '');
}
function rmEncAll(s) {
	//remove everything between first and last brackets
	return s.replace(/\x28.*\x29/g, '');
}
function rmBrac(s) {
	//removes parentheses, keeping the contents
	return s.replace(/[()]/g, '');
}
function rmPunc(s) {
	//removes other punctuation
	return s.replace(/[.,\/#?!$%\^&\'"*;:{}=\-_`~　…〜～－。、・？！＠＃＄％＾＆＊（）]/g, '');
}
function rmSpaces(s) {
	//removes spaces from the start and the end, replaces japanese and non-breaking spaces, removes repeated spaces
	return s.replace("&nbsp;"," ").trim().replace(/　/g, ' ').replace(/\s+/g, ' ');
}
function cfStrings(sQ, sA) {
 //unify case and remove punctuation
	var sq = rmSpaces(rmPunc(sQ.toLowerCase()));
	var sa = rmSpaces(rmPunc(sA.toLowerCase()));

	if (sq == sa) {
		return true;
	}
	if (rmSpaces(rmEnc(rmEnc(sq))) == sa) {
		return true;
	}
	if (rmSpaces(rmBrac(sq)) == sa) {
		return true;
	}
	return false;
}

//A (B) -> {〃, A, A B}
//A; B -> {〃, A, B}
//A; B (C) -> {〃, A, B, B C, B (C)}
//todo?A (B; C) -> {〃, A B, A C}

// grade answer
allAlts = [...corrAns.split(/[;；]/), ...ansAlts];
console.log(`altertnatives: ${allAlts.join(' | ')}`);
if (isMCh) {
	keyboardButtons.forEach( btn => {
		if (btn.innerHTML === userAns) {
			btn.classList.add('pressed');
			if (btn.classList.contains('correct')) {
				wrap.classList.add('correct');
			}
		}
	})
	if (!wrap.classList.contains('correct')) {
		wrap.classList.add('wrong');
	}
} else if (cfStrings(corrAns, userAns)) {
	wrap.classList.add('correct');
} else if (allAlts.map((altAns) => cfStrings(altAns, userAns)).includes(true)) {
	wrap.classList.add('correct');
} else if (false) {
	wrap.classList.add('soclose');
} else {
	wrap.classList.add('wrong');	
}

//timeout flip
flipBtn = document.getElementById('mem-flip');
function MemFlip() {
	try {clearTimeout(activeTimeout)} catch (err) {};

	if (wrap.classList.contains("correct")) {
		autorateGood();
	} else {
		wrap.classList.add("backside");
		wrap.classList.remove("frontside");
		flipBtn.onclick = autorateAgain;
	}
}
flipBtn.onclick = MemFlip;

activeTimeout = setTimeout((pid0)=>{
//	console.log(pid, "|", pid0);
	if (pid !== pid0) return;
	MemFlip();
}, Math.round((window.flipDelay || 1.5) * 1000), pid);
delete window.flipDelay;

//Submit
function autorateAgain() {
		flipBtn.onclick = null;
		if (platform === 'desk') {
			pycmd('ease1');
		} else if (platform === 'android') {
			buttonAnswerEase1();
		}
		console.log("autorated 'again'");
}
function autorateGood() {
		flipBtn.onclick = null;
		if (platform === 'desk') {
			pycmd('ease3');
		} else if (platform === 'android') {
			buttonAnswerEase3();
		}
		console.log("autorated 'good'");
}


//Audio buttons animation
audioButtons = document.querySelectorAll('.card-content.back a.replay-button');
audioButtons.forEach((a) => {
	a.addEventListener("click", () => {
		audioButtons.forEach((b) => {
			b.classList.remove('active');
		});
    a.classList.add('active');

		a.classList.remove('pulse');
		void a.offsetHeight;
		a.classList.add('pulse');
	});
});

//spelling corrections

	
//const spellcheckHighlights = document.getElementById('spellcheck');
//if (spellcheckHighlights) {
//	spellcheckHighlights.innerHTML = mergedNodes.map(node => node.outerHTML).join('');
//}

</script>

<!-- --------------------- user posterior scripts --------------------- -->
<script>
  //place your scripts here

</script>