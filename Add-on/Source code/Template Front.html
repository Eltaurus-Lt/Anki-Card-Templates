{{#Learnable}}{{#Definition}}
<setting id="static_keys"> </setting>
<setting id="random_keys">asdf</setting>
<data id="correctAnswer">{{Learnable}}</data>
<data id="choices">{{Choices}}</data>
<div class="card-content front">
    <div class="overhead">
		   <div class="mem-instruction">
        Type the correct translation
      </div>
			 {{#Extra}}
					<div class="front-extra">
						<label>Extra</label>
						<span>{{Extra}}</span>
					</div>
				{{/Extra}}
    </div>
    <div class="mem-question memblob">
      {{Definition}}
    </div>
    <div class="mem-typing">
      <label>Learnable</label>
      <input id="typeans" type="text" inputmode="text">
    </div>
    <div id="scr-keyboard" class="desk-off">
      <div id="HintButton" class="membtn"><svg><path></path></svg>Hint</div>
    </div>
</div>
<a id="Lt" href="https://github.com/Eltaurus-Lt/Anki-Card-Templates"></a>
{{/Definition}}{{/Learnable}}




<!-- --------------------- user prior scripts --------------------- -->
<script>
  //place your scripts here

</script>


<!-- ---------------------  template scripts  --------------------- -->

<script>
//determine card side
wrap = document.getElementById('backwrap');
isFrontSide = !wrap;
</script>

<script>
//determine input type
isMCh = !!document.querySelector('.card-content.mch');
</script>

<script>
//determine platform
platform = '';
if (!document.documentElement.classList.contains("mobile")) {
	platform = 'desk';
} else if (document.documentElement.classList.contains("android")) {
	//var jsApiContract = { version: "0.0.3", developer: "eltaurus@inbox.lt" };
	//var api = new AnkiDroidJS(jsApiContract);
	platform = 'android';
} else {
	platform = 'ios';
}
</script>

<script>
//elements
typeAns = document.getElementById('typeans');
screenKeyboard = document.getElementById('scr-keyboard');
hintButton = document.getElementById('HintButton');
</script>

<script>
function storeAnswer(ans = "") {
	if (!ans && typeAns) {ans = typeAns.value};
	sessionStorage.setItem("userAnswer", ans);
}

if (isFrontSide) {
	storeAnswer("");
}
</script>

<script>
//determine the correct answer
corrAnsL = document.getElementById('correctAnswer');
corrAns = corrAnsL?.innerHTML || ""; //including alts

//extract primary, excluding alts
try {
	const tempL = document.createElement('div');
	tempL.innerHTML = corrAns;
	tempL.querySelectorAll('[part="alt"]').forEach((L) => {L.remove();});
	corrAns = !isMCh ? tempL.innerText.replace("&nbsp;"," ").trim() : tempL.innerHTML;
	tempL.remove();
} catch (err) {}

hintAns = corrAns.split(/[;；]/)[0];

//determine alt answers
try {
	const altsString = [...corrAnsL.querySelectorAll('[part="alt"]')].map(L => L.innerText).join('|');
	ansAlts = altsString ? altsString.split('|').map(altAns => altAns.replace("&nbsp;"," ").trim()) : [];
} catch (err) {}
</script>

<script>
//consts
keysString = document.getElementById('static_keys')?.innerText || "";
fillerString = document.getElementById('random_keys')?.innerText || "";
choices = document.getElementById('choices')?.innerHTML.split('|').map(s => s.replace("&nbsp;"," ").trim()) || '';
</script>

<script>
//keyboard navigation
tabSelected = null;
document.onkeyup = function (e) {
	var ev = window.event || e;
	
	if (ev.key === 'Tab') {
		tabSelected = document.activeElement;
	}
}

document.onkeydown = function (e) {
	var ev = window.event || e;

	if (ev.key === 'Enter' && (tabSelected !== document.activeElement || tabSelected?.id === 'typeans')) {
		//last action was NOT selecting element with Tab -> Enter=flip (prevent audio activation)
		if (document.activeElement.matches('a.replay-button.soundLink')) {
			document.activeElement.blur();
		}
		if (!isFrontSide) {
			if (flipBtn && flipBtn.onclick) {
				flipBtn.onclick();
			}
		} else {
			flipToBack();
		}
	}

	if ("0123456789".includes(ev.key) && isMCh) {
		let numkey = parseInt(ev.key);
		if (numkey == 0) {numkey = 10};
		const mchoiceButtons = screenKeyboard.querySelectorAll('*');
		if (numkey <= mchoiceButtons.length) {
			mchoiceButtons[numkey - 1].onclick();
		}
	}
}
</script>

<script>
//Audio buttons animation
audioButtonsFront = document.querySelectorAll('.card-content.front a.replay-button');
audioButtonsFront.forEach((a) => {
	a.addEventListener("click", () => {
		audioButtonsFront.forEach((b) => {
			b.classList.remove('active');
		});
    a.classList.add('active');

		a.classList.remove('pulse');
		void a.offsetHeight;
		a.classList.add('pulse');
	});
});
if (audioButtonsFront && audioButtonsFront.length > 0) {
	audioButtonsFront[0].classList.add('active');
	audioButtonsFront[0].classList.add('pulse');
}
</script>

<script>
//on-screen keyboard | mult-choice buttons

function shuffle(arr) {
  return arr.sort(() => 0.5 - Math.random());
}

if (screenKeyboard) {
	if (isFrontSide) {
		if (fillerString && corrAns && !isMCh) {
			//character keys
			if (typeof window.randomKeysN !== 'number') {randomKeysN = 10} //fallback
			neededKeys = shuffle(fillerString.split('')).slice(0, randomKeysN);
			neededKeys = shuffle([... new Set([...(corrAns.split('')), ...neededKeys])]);
			neededKeys = neededKeys.filter(key => !keysString.includes(key));
			keysString = neededKeys.join('') + keysString;
		} else if (isMCh) {
			//multiple-choice keys
			choices = choices.filter(choice => (choice !== corrAns && !!choice));
			choices = shuffle([... new Set(choices)]);
			choices.splice((window.mchOptionsN || 6) - 1);
			choices = [corrAns, ...choices];
			shuffle(choices);
			keysString = choices.join('|');
		}

		sessionStorage.setItem("card-keyboard", keysString);
	} else {
		keysString = sessionStorage.getItem("card-keyboard") || "";
	}

	if (!isMCh) {
	  keys = keysString.split('');
	} else {
		keys = keysString ? keysString.split('|') : [];
		screenKeyboard.innerHTML = '';
	}
  keys.reverse().forEach((key)=>{
    const keyButton = document.createElement("div");
    if (!isMCh) {
      keyButton.innerText = key;
    } else {
      keyButton.innerHTML = key;
    }
    keyButton.classList.add('membtn');
    if (!isMCh && (key === ' ' || key === '　')) {keyButton.classList.add('space')}
    if (isMCh && key === corrAns) {keyButton.classList.add('correct')}
    screenKeyboard.prepend(keyButton);
  })
} 
</script>

<script>
delete window.randomKeysN;
delete window.mchOptionsN;
</script>

<script>
/*keyboard key functions*/
keyboardButtons = document.querySelectorAll('#scr-keyboard > *');

function flipToBack() {
	if (!isFrontSide) return;
	if (platform === 'desk') {
		pycmd("ans");
	} else if (platform === 'android') {
		showAnswer();
	}
	console.log('preview flip');
}

function lengthOfCommonPart(str1, str2) {
	const minLength = Math.min(str1.length, str2.length);
	let i; 
	for (i = 0; str1[i] == str2[i] && i < minLength; i++) {}
	return i;
}

function typeHint() {
	if (!hintAns || !typeAns) return;
	const correctLength = lengthOfCommonPart(typeAns.value, hintAns);
	if (correctLength < hintAns.length) {
		typeAns.value = hintAns.slice(0, correctLength + 1);
		storeAnswer();

		if (platform === 'desk') {
			typeAns.focus();
		}
	} else {
		flipToBack();
	}
}

function typeKey(keyContent) {
	const cursorStart = typeAns.selectionStart;
	const cursorEnd = typeAns.selectionEnd;
	const currentInput = typeAns.value;

	typeAns.value = currentInput.slice(0, cursorStart) + keyContent + currentInput.slice(cursorEnd);
	typeAns.setSelectionRange(cursorStart + 1, cursorStart + 1);
	
	storeAnswer();
	typeAns.focus();
	if (platform !== 'desk') {
		typeAns.blur();
	}
}

if (isFrontSide) {
	keyboardButtons.forEach( btn => {
		if (btn.id === 'HintButton') {
			btn.onclick = typeHint;
		} else if (isMCh) {
			btn.onclick = ()=>{
				if (btn.classList.contains('pressed')) {
					storeAnswer("");
					btn.classList.remove('pressed');
				} else {
					storeAnswer(btn.innerHTML);
					keyboardButtons.forEach((b) => {
						b.classList.remove('pressed');
					});
					btn.classList.add('pressed');
				}
				flipToBack();
			};
		} else if (typeAns) {
			btn.onclick = ()=>{
				typeKey(btn.innerHTML); //innerText does not work for space
			};
		}
	});

	if (typeAns) {
		typeAns.addEventListener('input', (event) => {storeAnswer();});
	}
}
</script>

<!-- --------------------- user posterior scripts --------------------- -->
<script>
  //place your scripts here

</script>